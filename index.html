<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NAPLAN Year 3 Vocabulary å•è¯å­¦ä¹ </title>
<style>
:root{--bg:#F7F7F7;--card:#FFFFFF;--primary:#58CC02;--primary-dark:#489801;--success:#58CC02;--danger:#FF4B4B;--warning:#FFC800;--text:#3C3C3C;--muted:#AFAFAF;--border:#E5E5E5;--radius:16px;--blue:#1CB0F6;--purple:#CE82FF;--gold:#FFC800}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');

.header{background:linear-gradient(135deg,#58CC02 0%,#1CB0F6 50%,#CE82FF 100%);color:#fff;padding:24px 20px;text-align:center;border-bottom:4px solid #489801}
.header h1{font-size:1.6rem;font-weight:900;letter-spacing:-0.5px;text-shadow:0 2px 4px rgba(0,0,0,0.15)}
.header p{font-size:0.85rem;opacity:0.95;margin-top:6px;font-weight:600}

.stats-bar{display:flex;justify-content:center;gap:16px;padding:14px;background:#fff;border-bottom:2px solid var(--border);flex-wrap:wrap}
.stat{text-align:center;min-width:60px}
.stat-num{font-size:1.3rem;font-weight:900;color:var(--primary)}
.stat-num.green{color:var(--success)}
.stat-num.orange{color:var(--gold)}
.stat-num.red{color:var(--danger)}
.stat-label{font-size:0.7rem;color:var(--muted);font-weight:700}

.nav{display:flex;justify-content:center;gap:8px;padding:14px;background:#fff;border-bottom:2px solid var(--border);flex-wrap:wrap}
.nav button{padding:10px 18px;border:2px solid var(--border);border-radius:99px;background:#fff;font-size:0.82rem;font-weight:700;cursor:pointer;transition:all .2s;color:var(--text)}
.nav button.active{background:var(--primary);color:#fff;border-color:var(--primary-dark);box-shadow:0 4px 0 var(--primary-dark);transform:translateY(-1px)}
.nav button:hover:not(.active){border-color:var(--primary);color:var(--primary);background:#f0fce8}

/* Layout: main + sidebar */
.layout{display:flex;max-width:1000px;margin:0 auto;padding:20px;gap:16px}
.main-col{flex:1;min-width:0}
.side-col{width:280px;flex-shrink:0}

.card{background:var(--card);border-radius:var(--radius);padding:28px 24px;box-shadow:0 2px 0 var(--border),0 4px 16px rgba(0,0,0,0.06);border:2px solid var(--border);text-align:center;margin-bottom:16px}
.card h2{font-size:1.05rem;color:var(--muted);margin-bottom:4px;font-weight:800}
.card .subtitle{font-size:0.8rem;color:var(--muted);margin-bottom:12px;font-weight:600}

.clue-box{background:linear-gradient(135deg,#f0fce8,#e8f7fe);border:2px solid #b8e986;border-radius:16px;padding:22px;margin:12px 0}
.clue-chinese{font-size:1.6rem;font-weight:900;color:var(--text)}
.clue-english{font-size:1.1rem;color:var(--blue);margin-top:6px;font-style:italic;font-weight:700}

.letter-hint{font-size:1rem;color:var(--muted);letter-spacing:4px;margin:8px 0;font-family:monospace;font-weight:700}

.input-row{display:flex;gap:8px;justify-content:center;margin:16px 0}
.input-row input{font-size:1.3rem;padding:14px 18px;border:2px solid var(--border);border-radius:14px;width:280px;text-align:center;outline:none;transition:all .2s;font-weight:700;background:#fff;box-shadow:0 2px 0 var(--border)}
.input-row input:focus{border-color:var(--blue);box-shadow:0 2px 0 var(--blue)}
.input-row input.correct{border-color:var(--success);background:#f0fce8;box-shadow:0 2px 0 var(--primary-dark)}
.input-row input.wrong{border-color:var(--danger);background:#fff0f0;box-shadow:0 2px 0 #e53e3e}

.quiz-word{font-size:2.2rem;font-weight:900;margin:12px 0;color:var(--blue)}

.options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0}
.option{padding:16px 14px;border:2px solid var(--border);border-radius:14px;background:#fff;font-size:0.95rem;cursor:pointer;transition:all .15s;text-align:center;line-height:1.4;font-weight:600;box-shadow:0 3px 0 var(--border)}
.option:hover{border-color:var(--blue);background:#e8f7fe;color:var(--text);transform:translateY(-2px);box-shadow:0 5px 0 #0e8acc}
.option .opt-en{font-weight:700}
.option .opt-cn{font-size:0.8rem;color:var(--muted)}
.option:hover .opt-cn{color:#3C3C3C}
.option.correct{border-color:var(--success);background:#f0fce8;color:var(--primary-dark);box-shadow:0 3px 0 var(--primary-dark)}
.option.correct .opt-cn{color:var(--primary-dark)}
.option.wrong{border-color:var(--danger);background:#fff0f0;color:var(--danger);box-shadow:0 3px 0 #e53e3e}
.option.wrong .opt-cn{color:var(--danger)}
.option.disabled{pointer-events:none}
.options-words .option{font-size:1.2rem;font-weight:800;letter-spacing:1px}

.feedback{font-size:1.1rem;font-weight:800;margin:12px 0;min-height:32px}
.feedback.correct{color:var(--success)}
.feedback.wrong{color:var(--danger)}

.btn{padding:12px 28px;border:none;border-radius:14px;font-size:0.92rem;font-weight:800;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:0.5px;position:relative}
.btn:active{transform:translateY(2px)}
.btn-primary{background:var(--primary);color:#fff;box-shadow:0 4px 0 var(--primary-dark)}
.btn-primary:hover{background:#4db800;transform:translateY(-1px);box-shadow:0 5px 0 var(--primary-dark)}
.btn-primary:active{box-shadow:0 1px 0 var(--primary-dark)}
.btn-success{background:var(--primary);color:#fff;box-shadow:0 4px 0 var(--primary-dark)}
.btn-success:hover{background:#4db800}
.btn-success:active{box-shadow:0 1px 0 var(--primary-dark)}
.btn-danger{background:var(--danger);color:#fff;box-shadow:0 4px 0 #e53e3e}
.btn-danger:hover{background:#ff3333}
.btn-danger:active{box-shadow:0 1px 0 #e53e3e}
.btn-warning{background:var(--gold);color:#3C3C3C;box-shadow:0 4px 0 #d4a600}
.btn-warning:hover{background:#e6b400}
.btn-warning:active{box-shadow:0 1px 0 #d4a600}
.btn-outline{background:#fff;border:2px solid var(--border);color:var(--text);box-shadow:0 3px 0 var(--border);font-weight:700}
.btn-outline:hover{border-color:var(--blue);color:var(--blue);background:#e8f7fe}
.btn-small{padding:10px 18px;font-size:0.8rem}
.btn-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:12px}

.progress-bar{width:100%;height:10px;background:var(--border);border-radius:99px;margin:12px 0;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),#78D52E);border-radius:99px;transition:width .3s}

/* Sidebar: Wrong words */
.wrong-book{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 2px 0 var(--border),0 4px 16px rgba(0,0,0,0.06);border:2px solid var(--border)}
.wrong-book h3{font-size:0.9rem;color:var(--danger);margin-bottom:8px;display:flex;align-items:center;gap:6px;font-weight:800}
.wrong-book .count{background:#fff0f0;color:var(--danger);font-size:0.7rem;padding:2px 10px;border-radius:99px;font-weight:800}
.wrong-list{max-height:500px;overflow-y:auto}
.wrong-item{display:flex;align-items:center;gap:8px;padding:8px 6px;border-bottom:1px solid var(--border);font-size:0.8rem;text-align:left}
.wrong-item .wi-word{font-weight:800;font-size:0.9rem;color:var(--danger);min-width:70px}
.wrong-item .wi-def{color:var(--muted);flex:1;font-size:0.75rem;font-weight:600}
.wrong-item .wi-count{background:#fff0f0;color:var(--danger);font-size:0.65rem;padding:2px 8px;border-radius:99px;white-space:nowrap;font-weight:800}
.wrong-empty{color:var(--muted);font-size:0.85rem;padding:20px;text-align:center;font-weight:700}
.wrong-book .clear-btn{margin-top:10px;text-align:center}

.speak-btn{background:none;border:none;font-size:1.8rem;cursor:pointer;padding:4px 8px;border-radius:12px;transition:all .15s;vertical-align:middle}
.speak-btn:hover{background:#e8f7fe;transform:scale(1.15)}
.speak-btn:active{transform:scale(0.95)}
.speak-btn.small{font-size:1.1rem;padding:2px 4px}
.auto-speak{display:flex;align-items:center;justify-content:center;gap:6px;margin:8px 0;font-size:0.8rem;color:var(--muted);font-weight:600}
.auto-speak input{margin:0;accent-color:var(--primary)}

/* Word list */
.word-list{max-height:400px;overflow-y:auto;text-align:left}
.word-item{display:flex;justify-content:space-between;align-items:center;padding:10px 8px;border-bottom:1px solid var(--border);font-size:0.85rem;gap:6px}
.word-item .wi-left{flex:1}
.word-item .eng{font-weight:800;font-size:0.95rem}
.word-item .def{color:var(--muted);font-size:0.8rem;font-weight:600}
.word-item .badge{font-size:0.65rem;padding:2px 8px;border-radius:99px;font-weight:800;white-space:nowrap}
.badge-mastered{background:#f0fce8;color:var(--primary-dark)}
.badge-learning{background:#fff8e0;color:#b8860b}
.badge-new{background:#e8f7fe;color:var(--blue)}
.filter-tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.level-bar{display:flex;justify-content:center;gap:8px;padding:12px;background:#fff;border-bottom:2px solid var(--border);flex-wrap:wrap}
.level-btn{padding:8px 16px;border:2px solid var(--border);border-radius:99px;background:#fff;font-size:0.78rem;font-weight:700;cursor:pointer;transition:all .2s;box-shadow:0 2px 0 var(--border)}
.level-btn.active{background:var(--primary);color:#fff;border-color:var(--primary-dark);box-shadow:0 3px 0 var(--primary-dark);transform:translateY(-1px)}
.level-btn:hover:not(.active){border-color:var(--primary);color:var(--primary);background:#f0fce8}
.level-badge{display:inline-block;font-size:0.6rem;padding:2px 8px;border-radius:99px;font-weight:800;margin-left:4px;vertical-align:middle}
.lb-simple{background:#f0fce8;color:var(--primary-dark)}
.lb-common{background:#e8f7fe;color:var(--blue)}
.lb-difficult{background:#fff2e0;color:#c2410c}
.lb-challenging{background:#fff0f0;color:var(--danger)}

.filter-tab{padding:8px 16px;border-radius:99px;border:2px solid var(--border);font-size:0.8rem;cursor:pointer;background:#fff;font-weight:700;box-shadow:0 2px 0 var(--border);transition:all .2s}
.filter-tab.active{background:var(--primary);color:#fff;border-color:var(--primary-dark);box-shadow:0 3px 0 var(--primary-dark)}
.reveal-area{margin:8px 0;min-height:32px}
.reveal-word{font-size:1.4rem;font-weight:900;color:var(--danger)}
.reset-section{margin-top:20px;padding-top:16px;border-top:2px solid var(--border)}

/* Timer bar */
.timer-bar{position:fixed;bottom:0;left:0;right:0;height:12px;background:var(--border);z-index:999;border-radius:6px 6px 0 0}
.timer-fill{height:100%;border-radius:0 6px 6px 0;transition:width 0.1s linear;background:linear-gradient(90deg,var(--primary),var(--gold),var(--danger))}
.timer-label{position:fixed;bottom:14px;right:12px;font-size:0.78rem;font-weight:800;color:var(--text);z-index:1000;background:rgba(255,255,255,0.95);padding:4px 12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border:2px solid var(--border)}
/* Reward flash */
@keyframes rewardPop{0%{transform:scale(0.5);opacity:0}50%{transform:scale(1.3)}100%{transform:scale(1);opacity:1}}
@keyframes rewardFade{0%{opacity:1}100%{opacity:0;transform:translateY(-30px)}}
.reward-emoji{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);font-size:4rem;z-index:9999;pointer-events:none;animation:rewardPop 0.4s ease-out, rewardFade 0.6s 0.6s ease-out forwards}
@keyframes shakeX{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
.shake{animation:shakeX 0.4s ease}

@media(max-width:760px){
  .layout{flex-direction:column}
  .side-col{width:100%}
  .wrong-list{max-height:200px}
  .options{grid-template-columns:1fr}
  .input-row input{width:220px;font-size:1.1rem}
  .clue-chinese{font-size:1.3rem}
  .quiz-word{font-size:1.8rem}
  .nav button{padding:8px 14px;font-size:0.75rem}
}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ“š NAPLAN Vocabulary å•è¯å­¦ä¹ </h1>
  <p>Official NAPLAN Spelling Reference Â· 1198 Words Â· 4 Levels</p>
</div>

<div class="level-bar">
  <button class="level-btn active" data-level="all" onclick="setLevel('all',this)">ğŸŒŸ All å…¨éƒ¨</button>
  <button class="level-btn" data-level="simple" onclick="setLevel('simple',this)">ğŸŸ¢ Simple ç®€å•</button>
  <button class="level-btn" data-level="common" onclick="setLevel('common',this)">ğŸ”µ Common å¸¸è§</button>
  <button class="level-btn" data-level="difficult" onclick="setLevel('difficult',this)">ğŸŸ  Difficult è¾ƒéš¾</button>
  <button class="level-btn" data-level="challenging" onclick="setLevel('challenging',this)">ğŸ”´ Challenging æŒ‘æˆ˜</button>
</div>

<div class="stats-bar">
  <div class="stat"><div class="stat-num green" id="s-mastered">0</div><div class="stat-label">Mastered âœ…</div></div>
  <div class="stat"><div class="stat-num orange" id="s-learning">0</div><div class="stat-label">Learning ğŸ“</div></div>
  <div class="stat"><div class="stat-num" id="s-new">0</div><div class="stat-label">New ğŸ†•</div></div>
  <div class="stat"><div class="stat-num red" id="s-wrong">0</div><div class="stat-label">Wrong âŒ</div></div>
  <div class="stat"><div class="stat-num" id="s-total">0</div><div class="stat-label">Total</div></div>
</div>

<div class="nav">
  <button class="active" onclick="switchMode('spell')">âœï¸ Spell æ‹¼å†™</button>
  <button onclick="switchMode('match')">ğŸ”¤ Match é…å¯¹</button>
  <button onclick="switchMode('quiz')">ğŸ¯ Quiz è¯ä¹‰</button>
  <button onclick="switchMode('list')">ğŸ“‹ List è¯è¡¨</button>
  <button onclick="switchMode('wrong')">âŒ Wrong é”™é¢˜æœ¬</button>
</div>

<div class="layout">
<div class="main-col">

  <!-- SPELL MODE -->
  <div id="mode-spell">
    <div class="card">
      <h2>âœï¸ Spell the Word æ‹¼å†™å•è¯</h2>
      <div class="subtitle">Read the meaning, then type the word Â· çœ‹é‡Šä¹‰,æ‹¼å‡ºå•è¯</div>
      <div class="auto-speak"><label><input type="checkbox" id="auto-speak" checked> ğŸ”Š Auto-play sound è‡ªåŠ¨è¯»éŸ³</label></div>
      <div class="clue-box">
        <div class="clue-english" id="spell-en"></div>
        <div class="clue-chinese" id="spell-cn"></div>
      </div>
      <div class="letter-hint" id="spell-hint"></div>
      <div class="input-row">
        <input type="text" id="spell-input" placeholder="Type the word here..." autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
      </div>
      <div class="feedback" id="spell-feedback"></div>
      <div class="reveal-area" id="spell-reveal"></div>
      <div class="btn-row">
        <button class="btn btn-warning" onclick="goBack()">â† Back è¿”å›</button>
        <button class="btn btn-primary" onclick="checkSpelling()">Check âœ“</button>
        <button class="btn btn-outline" onclick="showHint()">Hint ğŸ’¡</button>
        <button class="btn btn-outline" onclick="speakWord()">ğŸ”Š Listen</button>
        <button class="btn btn-outline" onclick="revealAnswer()">Show ğŸ‘€</button>
        <button class="btn btn-success" onclick="nextSpell()">Next â†’</button>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
    </div>
  </div>

  <!-- MATCH MODE -->
  <div id="mode-match" style="display:none">
    <div class="card">
      <h2>ğŸ”¤ Pick the Word é€‰å•è¯</h2>
      <div class="subtitle">Read the meaning, pick the correct word Â· çœ‹é‡Šä¹‰,é€‰æ­£ç¡®å•è¯</div>
      <div class="clue-box">
        <div class="clue-english" id="match-en"></div>
        <div class="clue-chinese" id="match-cn"></div>
      </div>
      <div class="options options-words" id="match-options"></div>
      <div class="feedback" id="match-feedback"></div>
      <div class="btn-row">
        <button class="btn btn-warning" onclick="goBack()">â† Back è¿”å›</button>
        <button class="btn btn-outline" onclick="speakWord()">ğŸ”Š Listen</button>
        <button class="btn btn-success" id="match-next" onclick="nextMatch()" style="display:none">Next â†’</button>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progress-bar2"></div></div>
    </div>
  </div>

  <!-- QUIZ MODE -->
  <div id="mode-quiz" style="display:none">
    <div class="card">
      <h2>ğŸ¯ What Does It Mean? ä»€ä¹ˆæ„æ€?</h2>
      <div class="subtitle">See the word, pick the correct meaning Â· çœ‹å•è¯,é€‰æ­£ç¡®é‡Šä¹‰</div>
      <div class="quiz-word" id="quiz-word"></div>
      <button class="speak-btn" onclick="speakWord()" title="Listen">ğŸ”Š</button>
      <div class="options" id="quiz-options"></div>
      <div class="feedback" id="quiz-feedback"></div>
      <div class="btn-row">
        <button class="btn btn-warning" onclick="goBack()">â† Back è¿”å›</button>
        <button class="btn btn-success" id="quiz-next" onclick="nextQuiz()" style="display:none">Next â†’</button>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progress-bar3"></div></div>
    </div>
  </div>

  <!-- WORD LIST -->
  <div id="mode-list" style="display:none">
    <div class="card">
      <h2>ğŸ“‹ Word List è¯æ±‡è¡¨</h2>
      <div class="filter-tabs">
        <div class="filter-tab active" onclick="filterList('all',this)">All å…¨éƒ¨</div>
        <div class="filter-tab" onclick="filterList('new',this)">ğŸ†• New</div>
        <div class="filter-tab" onclick="filterList('learning',this)">ğŸ“ Learning</div>
        <div class="filter-tab" onclick="filterList('mastered',this)">âœ… Mastered</div>
      </div>
      <div class="word-list" id="word-list"></div>
      <div class="reset-section">
        <button class="btn btn-danger btn-small" onclick="resetProgress()">ğŸ”„ Reset All Progress é‡ç½®è¿›åº¦</button>
      </div>
    </div>
  </div>

  <!-- WRONG BOOK (full page) -->
  <div id="mode-wrong" style="display:none">
    <div class="card">
      <h2>âŒ Wrong Book é”™é¢˜æœ¬</h2>
      <div class="subtitle">Words you got wrong Â· ç­”é”™çš„å•è¯</div>
      <div id="wrong-full-list"></div>
      <div class="btn-row" style="margin-top:16px">
        <button class="btn btn-danger btn-small" onclick="clearWrongBook()">ğŸ—‘ï¸ Clear All æ¸…ç©ºé”™é¢˜æœ¬</button>
        <button class="btn btn-primary btn-small" onclick="practiceWrong()">ğŸ“ Practice Wrong Words ç»ƒé”™é¢˜</button>
      </div>
    </div>
  </div>

</div>

<!-- SIDEBAR: Wrong book (live) -->
<div class="side-col">
  <div class="wrong-book" id="wrong-sidebar">
    <h3>âŒ Wrong Book é”™é¢˜æœ¬ <span class="count" id="wrong-count">0</span></h3>
    <div class="wrong-list" id="wrong-list"></div>
    <div class="clear-btn" style="display:flex;gap:6px;justify-content:center">
      <button class="btn btn-outline btn-small" onclick="downloadWrongBook()">ğŸ“¥ Download ä¸‹è½½</button>
      <button class="btn btn-outline btn-small" onclick="clearWrongBook()">ğŸ—‘ï¸ Clear æ¸…ç©º</button>
    </div>
  </div>
</div>

</div>

<div class="timer-bar"><div class="timer-fill" id="timer-fill" style="width:100%"></div></div>
<div class="timer-label" id="timer-label">â±ï¸ 15s</div>

<script src="vocab.js"></script>
<script>
// === State ===
const STORAGE_KEY = 'naplan-vocab-v2';
const WRONG_KEY = 'naplan-wrong-v1';
let state = loadState();
let wrongBook = loadWrongBook(); // { word: { count: N, m: "...", e: "..." } }
let currentWord = null;
let previousWord = null; // for Go Back
let previousState = null; // snapshot for Go Back
let currentMode = 'spell';
let hintLevel = 0;
let answered = false;
let spellChecked = false; // track if user checked before next
let listFilter = 'all';
let history = []; // word history stack
let activeLevel = 'all';
let wrongRepeat = {}; // session-level: track how many times a wrong word has been re-shown
let timerInterval = null;
let timerStart = 0;
const TIMER_SECONDS = 15;
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// === Sound Effects (Web Audio API) ===
function playCorrectSound() {
  // Happy ascending chime ğŸµ
  const now = audioCtx.currentTime;
  [523, 659, 784, 1047].forEach((freq, i) => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.3, now + i * 0.1);
    gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.3);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(now + i * 0.1);
    osc.stop(now + i * 0.1 + 0.3);
  });
}

function playWrongSound() {
  // Buzzer descending ğŸ˜µ
  const now = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'square';
  osc.frequency.setValueAtTime(300, now);
  osc.frequency.linearRampToValueAtTime(150, now + 0.3);
  gain.gain.setValueAtTime(0.2, now);
  gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(now); osc.stop(now + 0.4);
}

function playTimeUpSound() {
  // Urgent double beep â°
  const now = audioCtx.currentTime;
  [0, 0.15].forEach(d => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'triangle'; osc.frequency.value = 880;
    gain.gain.setValueAtTime(0.25, now + d);
    gain.gain.exponentialRampToValueAtTime(0.01, now + d + 0.12);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(now + d); osc.stop(now + d + 0.12);
  });
}

// === Reward emoji pop ===
function showRewardEmoji(correct) {
  const el = document.createElement('div');
  el.className = 'reward-emoji';
  el.textContent = correct ? ['ğŸ‰','â­','ğŸ”¥','ğŸ’ª','ğŸ‘','ğŸŒŸ'][Math.floor(Math.random()*6)] : ['ğŸ˜¢','ğŸ’”','ğŸ™ˆ'][Math.floor(Math.random()*3)];
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1300);
}

// === Timer ===
function startTimer() {
  stopTimer();
  if (currentMode === 'list' || currentMode === 'wrong') return;
  timerStart = Date.now();
  const fill = document.getElementById('timer-fill');
  const label = document.getElementById('timer-label');
  fill.style.width = '100%';
  timerInterval = setInterval(() => {
    const elapsed = (Date.now() - timerStart) / 1000;
    const remaining = Math.max(0, TIMER_SECONDS - elapsed);
    const pct = (remaining / TIMER_SECONDS) * 100;
    fill.style.width = pct + '%';
    label.textContent = 'â±ï¸ ' + Math.ceil(remaining) + 's';
    if (remaining <= 0) {
      stopTimer();
      handleTimeUp();
    }
  }, 100);
}

function stopTimer() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
}

function handleTimeUp() {
  if (!currentWord) return;
  playTimeUpSound();
  if (currentMode === 'spell' && !spellChecked) {
    document.getElementById('spell-feedback').innerHTML = '<span class="wrong">â° Time up! æ—¶é—´åˆ°! Answer: ' + currentWord.w + '</span>';
    document.getElementById('spell-input').className = 'wrong';
    addToWrongBook(currentWord);
    const s = ws(currentWord.w); s.att++; s.t = Date.now();
    saveState(); updateStats();
    document.querySelector('.main-col .card')?.classList.add('shake');
    setTimeout(() => document.querySelector('.main-col .card')?.classList.remove('shake'), 500);
    setTimeout(loadSpell, 2000);
  } else if (currentMode === 'match' && !answered) {
    answered = true;
    document.getElementById('match-feedback').innerHTML = '<span class="wrong">â° Time up! Answer: ' + currentWord.w + '</span>';
    document.querySelectorAll('#match-options .option').forEach(o => { o.classList.add('disabled'); if(o.textContent===currentWord.w) o.classList.add('correct'); });
    addToWrongBook(currentWord);
    const s = ws(currentWord.w); s.att++; s.t = Date.now();
    saveState(); updateStats();
    document.getElementById('match-next').style.display = 'inline-block';
  } else if (currentMode === 'quiz' && !answered) {
    answered = true;
    document.getElementById('quiz-feedback').innerHTML = '<span class="wrong">â° Time up! Answer: ' + enDef(currentWord) + ' / ' + currentWord.m + '</span>';
    document.querySelectorAll('#quiz-options .option').forEach(o => { o.classList.add('disabled'); if(o.querySelector('.opt-en')?.textContent===enDef(currentWord)) o.classList.add('correct'); });
    addToWrongBook(currentWord);
    const s = ws(currentWord.w); s.att++; s.t = Date.now();
    saveState(); updateStats();
    document.getElementById('quiz-next').style.display = 'inline-block';
  }
}

function getFilteredVocab() {
  if (activeLevel === 'all') return VOCAB;
  return VOCAB.filter(v => v.l === activeLevel);
}

function setLevel(level, el) {
  activeLevel = level;
  document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  updateStats();
  renderWrongSidebar();
  if (currentMode === 'spell') loadSpell();
  else if (currentMode === 'match') loadMatch();
  else if (currentMode === 'quiz') loadQuiz();
  else if (currentMode === 'list') renderList();
  else if (currentMode === 'wrong') renderWrongFullList();
}

function loadState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } }
function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadWrongBook() { try { return JSON.parse(localStorage.getItem(WRONG_KEY)) || {}; } catch { return {}; } }
function saveWrongBook() { localStorage.setItem(WRONG_KEY, JSON.stringify(wrongBook)); renderWrongSidebar(); }

function ws(w) {
  if (!state[w]) state[w] = { sp:0, ma:0, qu:0, att:0, t:0 };
  return state[w];
}

function getStatus(w) {
  const s = ws(w);
  if (s.sp >= 2 && (s.ma >= 2 || s.qu >= 2)) return 'mastered';
  if (s.att > 0) return 'learning';
  return 'new';
}

function getCounts() {
  let m=0,l=0,n=0;
  const fv = getFilteredVocab();
  const fvSet = new Set(fv.map(v=>v.w));
  for (const v of fv) { const st=getStatus(v.w); if(st==='mastered')m++; else if(st==='learning')l++; else n++; }
  const wc = Object.keys(wrongBook).filter(k => fvSet.has(k)).length;
  return {mastered:m, learning:l, new:n, total:fv.length, wrong:wc};
}

function updateStats() {
  const c = getCounts();
  document.getElementById('s-mastered').textContent = c.mastered;
  document.getElementById('s-learning').textContent = c.learning;
  document.getElementById('s-new').textContent = c.new;
  document.getElementById('s-wrong').textContent = c.wrong;
  document.getElementById('s-total').textContent = c.total;
  const pct = c.total > 0 ? (c.mastered / c.total * 100) : 0;
  document.querySelectorAll('[id^="progress-bar"]').forEach(el => el.style.width = pct + '%');
  document.getElementById('wrong-count').textContent = c.wrong;
}

// === Wrong Book ===
function addToWrongBook(v) {
  const key = v.w;
  if (!wrongBook[key]) {
    wrongBook[key] = { count: 1, m: v.m, e: enDef(v) };
  } else {
    wrongBook[key].count++;
  }
  saveWrongBook();
  updateStats();
}

function renderWrongSidebar() {
  const entries = Object.entries(wrongBook).sort((a,b) => b[1].count - a[1].count);
  const container = document.getElementById('wrong-list');
  if (!entries.length) {
    container.innerHTML = '<div class="wrong-empty">ğŸ‰ No wrong words!<br>æ²¡æœ‰é”™é¢˜!</div>';
    return;
  }
  let html = '';
  for (const [w, info] of entries) {
    html += `<div class="wrong-item">
      <button class="speak-btn small" onclick="speak('${w}','en-US')">ğŸ”Š</button>
      <span class="wi-word">${w}</span>
      <span class="wi-def">${info.e} Â· ${info.m}</span>
      <span class="wi-count">Ã—${info.count}</span>
    </div>`;
  }
  container.innerHTML = html;
}

function renderWrongFullList() {
  const entries = Object.entries(wrongBook).sort((a,b) => b[1].count - a[1].count);
  const container = document.getElementById('wrong-full-list');
  if (!entries.length) {
    container.innerHTML = '<div class="wrong-empty" style="padding:40px">ğŸ‰ Great job! No wrong words!<br>å¤ªæ£’äº†!æ²¡æœ‰é”™é¢˜!</div>';
    return;
  }
  let html = '<div class="word-list" style="max-height:500px">';
  for (const [w, info] of entries) {
    html += `<div class="word-item">
      <button class="speak-btn small" onclick="speak('${w}','en-US')">ğŸ”Š</button>
      <div class="wi-left"><span class="eng" style="color:var(--danger)">${w}</span><br>
      <span class="def">${info.e} Â· ${info.m}</span></div>
      <span style="color:var(--danger);font-weight:700;font-size:0.85rem">Ã—${info.count}</span>
    </div>`;
  }
  html += '</div>';
  container.innerHTML = html;
}

function clearWrongBook() {
  if (confirm('Clear all wrong words? ç¡®å®šæ¸…ç©ºé”™é¢˜æœ¬?')) {
    wrongBook = {}; wrongRepeat = {};
    saveWrongBook();
    updateStats();
    renderWrongFullList();
  }
}

function downloadWrongBook() {
  const entries = Object.entries(wrongBook).sort((a,b) => b[1].count - a[1].count);
  if (!entries.length) { alert('No wrong words to download!\næ²¡æœ‰é”™é¢˜å¯ä¸‹è½½!'); return; }
  let text = 'NAPLAN Wrong Words é”™é¢˜æœ¬\n' + '='.repeat(40) + '\n\n';
  for (const [w, info] of entries) {
    text += `${w}  â€”  ${info.e}  Â·  ${info.m}  (Ã—${info.count})\n`;
  }
  text += '\n' + '='.repeat(40) + '\nTotal: ' + entries.length + ' words\n';
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'naplan-wrong-words.txt';
  a.click();
  URL.revokeObjectURL(a.href);
}

function practiceWrong() {
  // Switch to spell mode but only with wrong words
  alert('Tip: Wrong words are already prioritized in your practice!\næç¤º:é”™é¢˜å•è¯å·²ç»åœ¨ç»ƒä¹ ä¸­ä¼˜å…ˆå‡ºç°äº†!');
  switchModeByName('spell');
}

// === Word picker ===
function pickWord() {
  const pool = getFilteredVocab();
  const cands = [];
  
  // Wrong words that still need 1-2 repeats (but cap at 2 extra appearances)
  const wrongCands = [];
  for (const v of pool) {
    if (wrongBook[v.w] && (!wrongRepeat[v.w] || wrongRepeat[v.w] < 2)) {
      wrongCands.push(v);
    }
  }
  
  // 40% chance to pick a wrong word if available (not too frequent, kids get bored)
  if (wrongCands.length > 0 && Math.random() < 0.4) {
    const pick = wrongCands[Math.floor(Math.random() * wrongCands.length)];
    wrongRepeat[pick.w] = (wrongRepeat[pick.w] || 0) + 1;
    return pick;
  }
  
  // Normal pool: exclude mastered, pick randomly (truly random)
  for (const v of pool) {
    const st = getStatus(v.w);
    if (st !== 'mastered') cands.push(v);
  }
  
  if (!cands.length) return pool[Math.floor(Math.random() * pool.length)];
  
  // Avoid repeating the same word twice in a row
  let pick;
  let tries = 0;
  do {
    pick = cands[Math.floor(Math.random() * cands.length)];
    tries++;
  } while (pick === currentWord && cands.length > 1 && tries < 5);
  
  return pick;
}

function enDef(v) { return v.e || v.m; }

// === GO BACK ===
function saveSnapshot() {
  return JSON.parse(JSON.stringify(state));
}

function goBack() {
  if (!previousWord) return;
  // Restore state
  if (previousState) {
    state = previousState;
    saveState();
  }
  // Remove from wrong book if it was added this round
  // (we'll just reload the previous word)
  currentWord = previousWord;
  previousWord = null;
  previousState = null;
  
  if (currentMode === 'spell') restoreSpell();
  else if (currentMode === 'match') restoreMatch();
  else if (currentMode === 'quiz') restoreQuiz();
  
  updateStats();
  renderWrongSidebar();
}

function restoreSpell() {
  hintLevel = 0; spellChecked = false;
  document.getElementById('spell-en').textContent = enDef(currentWord);
  document.getElementById('spell-cn').textContent = currentWord.m;
  document.getElementById('spell-hint').textContent = `( ${currentWord.w.length} letters )`;
  document.getElementById('spell-input').value = '';
  document.getElementById('spell-input').className = '';
  document.getElementById('spell-feedback').innerHTML = '<span style="color:var(--warning)">â¬…ï¸ Went back Â· å·²è¿”å›ä¸Šä¸€é¢˜</span>';
  document.getElementById('spell-reveal').innerHTML = '';
  document.getElementById('spell-input').focus();
}

// === SPELL MODE ===
function loadSpell() {
  previousWord = currentWord;
  previousState = saveSnapshot();
  currentWord = pickWord();
  hintLevel = 0; spellChecked = false;
  document.getElementById('spell-en').textContent = enDef(currentWord);
  document.getElementById('spell-cn').textContent = currentWord.m;
  document.getElementById('spell-hint').textContent = `( ${currentWord.w.length} letters )`;
  document.getElementById('spell-input').value = '';
  document.getElementById('spell-input').className = '';
  document.getElementById('spell-feedback').innerHTML = '';
  document.getElementById('spell-reveal').innerHTML = '';
  document.getElementById('spell-input').focus();
  startTimer();
}

function checkSpelling() {
  const inp = document.getElementById('spell-input').value.trim().toLowerCase();
  if (!inp) return;
  const correct = currentWord.w.toLowerCase();
  const s = ws(currentWord.w); s.att++; s.t = Date.now();
  spellChecked = true;

  if (inp === correct) {
    stopTimer();
    s.sp++;
    document.getElementById('spell-input').className = 'correct';
    document.getElementById('spell-feedback').innerHTML = '<span class="correct">âœ… Correct! æ­£ç¡®!</span>';
    playCorrectSound(); showRewardEmoji(true);
    speak(currentWord.w, 'en-US');
    saveState(); updateStats();
    setTimeout(loadSpell, 1500);
  } else {
    s.sp = Math.max(0, s.sp - 1);
    document.getElementById('spell-input').className = 'wrong';
    document.getElementById('spell-feedback').innerHTML = `<span class="wrong">âŒ Try again! å†è¯•ä¸€æ¬¡! (Answer: ${currentWord.w})</span>`;
    playWrongSound(); showRewardEmoji(false);
    document.querySelector('.main-col .card')?.classList.add('shake');
    setTimeout(() => document.querySelector('.main-col .card')?.classList.remove('shake'), 500);
    addToWrongBook(currentWord);
    saveState(); updateStats();
  }
}

function showHint() {
  if (!currentWord) return;
  hintLevel++;
  const w = currentWord.w;
  let hint;
  if (hintLevel === 1) hint = w[0] + ' _ '.repeat(w.length-2).trim() + ' ' + w[w.length-1];
  else if (hintLevel === 2) hint = w.split('').map((c,i) => i%2===0?c:'_').join(' ');
  else { const h=Math.floor(Math.random()*(w.length-2))+1; hint=w.split('').map((c,i) => i===h?'_':c).join(' '); }
  document.getElementById('spell-hint').textContent = hint;
}

function revealAnswer() {
  if (!currentWord) return;
  document.getElementById('spell-reveal').innerHTML = `<span class="reveal-word">${currentWord.w}</span>`;
  speak(currentWord.w, 'en-US');
  if (!spellChecked) {
    // User revealed without trying â€” counts as wrong
    addToWrongBook(currentWord);
  }
  const s = ws(currentWord.w); s.sp = Math.max(0, s.sp-1); s.att++; s.t = Date.now();
  saveState(); updateStats();
}

function nextSpell() { loadSpell(); }

// === MATCH MODE ===
function loadMatch() {
  previousWord = currentWord;
  previousState = saveSnapshot();
  currentWord = pickWord(); answered = false;
  document.getElementById('match-en').textContent = enDef(currentWord);
  document.getElementById('match-cn').textContent = currentWord.m;
  document.getElementById('match-feedback').innerHTML = '';
  document.getElementById('match-next').style.display = 'none';
  autoSpeak();
  startTimer();

  const correctW = currentWord.w;
  const wrongs = [];
  const pool = getFilteredVocab().filter(v => v.w !== correctW);
  const len = correctW.length;
  pool.sort((a,b) => Math.abs(a.w.length-len) - Math.abs(b.w.length-len));
  const similar = pool.slice(0, Math.min(30, pool.length));
  while (wrongs.length < 3 && similar.length > 0) {
    const idx = Math.floor(Math.random()*similar.length);
    wrongs.push(similar[idx].w);
    similar.splice(idx,1);
  }
  const opts = [correctW, ...wrongs]; shuffle(opts);
  const container = document.getElementById('match-options');
  container.innerHTML = '';
  opts.forEach(w => {
    const btn = document.createElement('div');
    btn.className = 'option'; btn.textContent = w;
    btn.onclick = () => selectMatch(btn, w, correctW);
    container.appendChild(btn);
  });
}

function restoreMatch() {
  answered = false;
  document.getElementById('match-en').textContent = enDef(currentWord);
  document.getElementById('match-cn').textContent = currentWord.m;
  document.getElementById('match-feedback').innerHTML = '<span style="color:var(--warning)">â¬…ï¸ Went back Â· å·²è¿”å›ä¸Šä¸€é¢˜</span>';
  document.getElementById('match-next').style.display = 'none';
  const correctW = currentWord.w;
  const wrongs = [];
  const pool = getFilteredVocab().filter(v => v.w !== correctW);
  const len = correctW.length;
  pool.sort((a,b) => Math.abs(a.w.length-len) - Math.abs(b.w.length-len));
  const similar = pool.slice(0, Math.min(30, pool.length));
  while (wrongs.length < 3 && similar.length > 0) {
    const idx = Math.floor(Math.random()*similar.length); wrongs.push(similar[idx].w); similar.splice(idx,1);
  }
  const opts = [correctW, ...wrongs]; shuffle(opts);
  const container = document.getElementById('match-options');
  container.innerHTML = '';
  opts.forEach(w => {
    const btn = document.createElement('div'); btn.className = 'option'; btn.textContent = w;
    btn.onclick = () => selectMatch(btn, w, correctW);
    container.appendChild(btn);
  });
}

function selectMatch(btn, selected, correct) {
  if (answered) return;
  answered = true;
  document.querySelectorAll('#match-options .option').forEach(o => o.classList.add('disabled'));
  const s = ws(currentWord.w); s.att++; s.t = Date.now();
  stopTimer();
  if (selected === correct) {
    s.ma++; btn.classList.add('correct');
    document.getElementById('match-feedback').innerHTML = '<span class="correct">âœ… Correct! æ­£ç¡®!</span>';
    playCorrectSound(); showRewardEmoji(true);
  } else {
    s.ma = Math.max(0, s.ma-1); btn.classList.add('wrong');
    document.querySelectorAll('#match-options .option').forEach(o => { if(o.textContent===correct) o.classList.add('correct'); });
    document.getElementById('match-feedback').innerHTML = `<span class="wrong">âŒ Answer: <strong>${correct}</strong></span>`;
    playWrongSound(); showRewardEmoji(false);
    addToWrongBook(currentWord);
  }
  saveState(); updateStats();
  document.getElementById('match-next').style.display = 'inline-block';
}

function nextMatch() { loadMatch(); }

// === QUIZ MODE ===
function loadQuiz() {
  previousWord = currentWord;
  previousState = saveSnapshot();
  currentWord = pickWord(); answered = false;
  document.getElementById('quiz-word').textContent = currentWord.w;
  document.getElementById('quiz-feedback').innerHTML = '';
  document.getElementById('quiz-next').style.display = 'none';
  autoSpeak();
  startTimer();

  const correctM = currentWord.m, correctE = enDef(currentWord);
  const wrongs = [];
  const pool = getFilteredVocab().filter(v => v.w !== currentWord.w);
  while (wrongs.length < 3 && pool.length > 0) {
    const idx = Math.floor(Math.random()*pool.length);
    const v = pool[idx];
    if (!wrongs.find(x => x.m === v.m)) wrongs.push({ m: v.m, e: enDef(v) });
    pool.splice(idx,1);
  }
  const opts = [{ m:correctM, e:correctE, correct:true }, ...wrongs.map(x=>({...x,correct:false}))];
  shuffle(opts);
  const container = document.getElementById('quiz-options');
  container.innerHTML = '';
  opts.forEach(opt => {
    const btn = document.createElement('div'); btn.className = 'option';
    btn.innerHTML = `<div class="opt-en">${opt.e}</div><div class="opt-cn">${opt.m}</div>`;
    btn.onclick = () => selectQuiz(btn, opt.correct, correctE, correctM);
    container.appendChild(btn);
  });
}

function restoreQuiz() {
  answered = false;
  document.getElementById('quiz-word').textContent = currentWord.w;
  document.getElementById('quiz-feedback').innerHTML = '<span style="color:var(--warning)">â¬…ï¸ Went back Â· å·²è¿”å›ä¸Šä¸€é¢˜</span>';
  document.getElementById('quiz-next').style.display = 'none';
  const correctM = currentWord.m, correctE = enDef(currentWord);
  const wrongs = [];
  const pool = getFilteredVocab().filter(v => v.w !== currentWord.w);
  while (wrongs.length < 3 && pool.length > 0) {
    const idx = Math.floor(Math.random()*pool.length); const v = pool[idx];
    if (!wrongs.find(x => x.m === v.m)) wrongs.push({ m: v.m, e: enDef(v) });
    pool.splice(idx,1);
  }
  const opts = [{ m:correctM, e:correctE, correct:true }, ...wrongs.map(x=>({...x,correct:false}))];
  shuffle(opts);
  const container = document.getElementById('quiz-options');
  container.innerHTML = '';
  opts.forEach(opt => {
    const btn = document.createElement('div'); btn.className = 'option';
    btn.innerHTML = `<div class="opt-en">${opt.e}</div><div class="opt-cn">${opt.m}</div>`;
    btn.onclick = () => selectQuiz(btn, opt.correct, correctE, correctM);
    container.appendChild(btn);
  });
}

function selectQuiz(btn, isCorrect, correctE, correctM) {
  if (answered) return;
  answered = true;
  document.querySelectorAll('#quiz-options .option').forEach(o => o.classList.add('disabled'));
  const s = ws(currentWord.w); s.att++; s.t = Date.now();
  stopTimer();
  if (isCorrect) {
    s.qu++; btn.classList.add('correct');
    document.getElementById('quiz-feedback').innerHTML = '<span class="correct">âœ… Correct! æ­£ç¡®!</span>';
    playCorrectSound(); showRewardEmoji(true);
  } else {
    s.qu = Math.max(0, s.qu-1); btn.classList.add('wrong');
    document.querySelectorAll('#quiz-options .option').forEach(o => {
      if (o.querySelector('.opt-en').textContent === correctE) o.classList.add('correct');
    });
    document.getElementById('quiz-feedback').innerHTML = `<span class="wrong">âŒ Answer: ${correctE} / ${correctM}</span>`;
    playWrongSound(); showRewardEmoji(false);
    addToWrongBook(currentWord);
  }
  saveState(); updateStats();
  document.getElementById('quiz-next').style.display = 'inline-block';
}

function nextQuiz() { loadQuiz(); }

// === WORD LIST ===
function levelBadge(v) {
  if (!v.l) return '';
  const cls = {simple:'lb-simple',common:'lb-common',difficult:'lb-difficult',challenging:'lb-challenging'}[v.l]||'';
  return `<span class="level-badge ${cls}">${v.l}</span>`;
}

function renderList() {
  const sorted = [...getFilteredVocab()].sort((a,b) => a.w.localeCompare(b.w));
  let html = '';
  for (const v of sorted) {
    const st = getStatus(v.w);
    if (listFilter !== 'all' && st !== listFilter) continue;
    let bc, bt;
    if (st==='mastered'){bc='badge-mastered';bt='âœ… Mastered';}
    else if(st==='learning'){bc='badge-learning';bt='ğŸ“ Learning';}
    else{bc='badge-new';bt='ğŸ†• New';}
    const inWrong = wrongBook[v.w] ? `<span style="color:var(--danger);font-size:0.7rem"> Ã—${wrongBook[v.w].count}</span>` : '';
    html += `<div class="word-item">
      <button class="speak-btn small" onclick="speak('${v.w}','en-US')">ğŸ”Š</button>
      <div class="wi-left"><span class="eng">${v.w}</span>${levelBadge(v)}${inWrong}<br>
      <span class="def">${enDef(v)} Â· ${v.m}</span></div>
      <span class="badge ${bc}">${bt}</span></div>`;
  }
  if(!html) html = '<div style="padding:20px;text-align:center;color:var(--muted)">No words found</div>';
  document.getElementById('word-list').innerHTML = html;
}

function filterList(f, el) {
  listFilter = f;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderList();
}

function resetProgress() {
  if (confirm('Reset ALL progress? ç¡®å®šé‡ç½®æ‰€æœ‰è¿›åº¦?')) {
    state = {}; wrongBook = {};
    saveState(); saveWrongBook(); updateStats(); init();
  }
}

// === TTS ===
let voices = [];
function loadVoices() { voices = speechSynthesis.getVoices(); }
speechSynthesis.onvoiceschanged = loadVoices; loadVoices();

function getEnVoice() {
  return voices.find(v => v.lang.startsWith('en') && v.name.includes('Google')) ||
    voices.find(v => v.lang.startsWith('en-US')) ||
    voices.find(v => v.lang.startsWith('en-AU')) ||
    voices.find(v => v.lang.startsWith('en')) || null;
}

function speak(text, lang) {
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang || 'en-US'; u.rate = 0.85;
  const v = getEnVoice();
  if (v && (lang||'en').startsWith('en')) u.voice = v;
  speechSynthesis.speak(u);
}

function speakWord() { if (currentWord) speak(currentWord.w, 'en-US'); }

function autoSpeak() {
  const cb = document.getElementById('auto-speak');
  if (cb && cb.checked && currentWord) setTimeout(() => speak(currentWord.w, 'en-US'), 300);
}

// === Helpers ===
function shuffle(arr) {
  for (let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}
}

function switchModeByName(mode) {
  currentMode = mode;
  document.querySelectorAll('.nav button').forEach(b => {
    b.classList.toggle('active', b.textContent.toLowerCase().includes(mode));
  });
  ['spell','match','quiz','list','wrong'].forEach(m => {
    const el = document.getElementById('mode-'+m);
    if (el) el.style.display = m===mode?'block':'none';
  });
  if (mode==='spell') loadSpell();
  else if (mode==='match') loadMatch();
  else if (mode==='quiz') loadQuiz();
  else if (mode==='list') renderList();
  else if (mode==='wrong') renderWrongFullList();
}

function switchMode(mode) {
  currentMode = mode;
  if (mode === 'list' || mode === 'wrong') { stopTimer(); document.getElementById('timer-fill').style.width = '100%'; document.getElementById('timer-label').textContent = 'â±ï¸ --'; }
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  ['spell','match','quiz','list','wrong'].forEach(m => {
    const el = document.getElementById('mode-'+m);
    if (el) el.style.display = m===mode?'block':'none';
  });
  if (mode==='spell') loadSpell();
  else if (mode==='match') loadMatch();
  else if (mode==='quiz') loadQuiz();
  else if (mode==='list') renderList();
  else if (mode==='wrong') renderWrongFullList();
}

function init() {
  updateStats();
  renderWrongSidebar();
  loadSpell();
}

document.addEventListener('keydown', e => {
  if (currentMode==='spell' && e.key==='Enter') checkSpelling();
});

init();
</script>
</body>
</html>

