<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NAPLAN Year 3 Vocabulary å•è¯å­¦ä¹ </title>
<style>
:root{--bg:#f0f4f8;--card:#fff;--primary:#3b82f6;--primary-dark:#2563eb;--success:#22c55e;--danger:#ef4444;--warning:#f59e0b;--text:#1e293b;--muted:#64748b;--border:#e2e8f0;--radius:16px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

.header{background:linear-gradient(135deg,#1e40af 0%,#7c3aed 50%,#db2777 100%);color:#fff;padding:20px;text-align:center}
.header h1{font-size:1.5rem;font-weight:800}
.header p{font-size:0.85rem;opacity:0.9;margin-top:4px}

.stats-bar{display:flex;justify-content:center;gap:16px;padding:12px;background:#fff;border-bottom:1px solid var(--border);flex-wrap:wrap}
.stat{text-align:center;min-width:60px}
.stat-num{font-size:1.3rem;font-weight:800;color:var(--primary)}
.stat-num.green{color:var(--success)}
.stat-num.orange{color:var(--warning)}
.stat-num.red{color:var(--danger)}
.stat-label{font-size:0.7rem;color:var(--muted)}

.nav{display:flex;justify-content:center;gap:6px;padding:12px;background:#fff;border-bottom:1px solid var(--border);flex-wrap:wrap}
.nav button{padding:8px 16px;border:2px solid var(--border);border-radius:99px;background:#fff;font-size:0.8rem;font-weight:600;cursor:pointer;transition:all .15s}
.nav button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.nav button:hover:not(.active){border-color:var(--primary);color:var(--primary)}

/* Layout: main + sidebar */
.layout{display:flex;max-width:1000px;margin:0 auto;padding:20px;gap:16px}
.main-col{flex:1;min-width:0}
.side-col{width:280px;flex-shrink:0}

.card{background:var(--card);border-radius:var(--radius);padding:28px 24px;box-shadow:0 4px 24px rgba(0,0,0,0.08);text-align:center;margin-bottom:16px}
.card h2{font-size:1rem;color:var(--muted);margin-bottom:4px}
.card .subtitle{font-size:0.8rem;color:var(--muted);margin-bottom:12px}

.clue-box{background:linear-gradient(135deg,#eff6ff,#f5f3ff);border:2px solid #c7d2fe;border-radius:14px;padding:20px;margin:12px 0}
.clue-chinese{font-size:1.6rem;font-weight:800;color:var(--text)}
.clue-english{font-size:1.1rem;color:var(--primary);margin-top:6px;font-style:italic}

.letter-hint{font-size:1rem;color:var(--muted);letter-spacing:4px;margin:8px 0;font-family:monospace}

.input-row{display:flex;gap:8px;justify-content:center;margin:16px 0}
.input-row input{font-size:1.3rem;padding:12px 16px;border:2px solid var(--border);border-radius:12px;width:280px;text-align:center;outline:none;transition:border-color .15s}
.input-row input:focus{border-color:var(--primary)}
.input-row input.correct{border-color:var(--success);background:#f0fdf4}
.input-row input.wrong{border-color:var(--danger);background:#fef2f2}

.quiz-word{font-size:2.2rem;font-weight:800;margin:12px 0;color:var(--primary)}

.options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0}
.option{padding:14px 12px;border:2px solid var(--border);border-radius:12px;background:#fff;font-size:0.95rem;cursor:pointer;transition:all .15s;text-align:center;line-height:1.4}
.option:hover{border-color:var(--primary);background:var(--primary);color:#fff;transform:scale(1.02)}
.option .opt-en{font-weight:600}
.option .opt-cn{font-size:0.8rem;color:var(--muted)}
.option:hover .opt-cn{color:rgba(255,255,255,0.8)}
.option.correct{border-color:var(--success);background:#f0fdf4;color:var(--success)}
.option.correct .opt-cn{color:var(--success)}
.option.wrong{border-color:var(--danger);background:#fef2f2;color:var(--danger)}
.option.wrong .opt-cn{color:var(--danger)}
.option.disabled{pointer-events:none}
.options-words .option{font-size:1.2rem;font-weight:700;letter-spacing:1px}

.feedback{font-size:1.1rem;font-weight:700;margin:12px 0;min-height:32px}
.feedback.correct{color:var(--success)}
.feedback.wrong{color:var(--danger)}

.btn{padding:10px 24px;border:none;border-radius:12px;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all .15s}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-dark)}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-warning{background:var(--warning);color:#fff}
.btn-outline{background:#fff;border:2px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--primary)}
.btn-small{padding:8px 16px;font-size:0.8rem}
.btn-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:12px}

.progress-bar{width:100%;height:8px;background:var(--border);border-radius:99px;margin:12px 0;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--success));border-radius:99px;transition:width .3s}

/* Sidebar: Wrong words */
.wrong-book{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 4px 24px rgba(0,0,0,0.08)}
.wrong-book h3{font-size:0.9rem;color:var(--danger);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.wrong-book .count{background:#fef2f2;color:var(--danger);font-size:0.7rem;padding:1px 8px;border-radius:99px;font-weight:700}
.wrong-list{max-height:500px;overflow-y:auto}
.wrong-item{display:flex;align-items:center;gap:8px;padding:8px 6px;border-bottom:1px solid var(--border);font-size:0.8rem;text-align:left}
.wrong-item .wi-word{font-weight:700;font-size:0.9rem;color:var(--danger);min-width:70px}
.wrong-item .wi-def{color:var(--muted);flex:1;font-size:0.75rem}
.wrong-item .wi-count{background:#fef2f2;color:var(--danger);font-size:0.65rem;padding:1px 6px;border-radius:99px;white-space:nowrap}
.wrong-empty{color:var(--muted);font-size:0.8rem;padding:20px;text-align:center}
.wrong-book .clear-btn{margin-top:10px;text-align:center}

.speak-btn{background:none;border:none;font-size:1.8rem;cursor:pointer;padding:4px 8px;border-radius:8px;transition:all .15s;vertical-align:middle}
.speak-btn:hover{background:#eff6ff;transform:scale(1.15)}
.speak-btn:active{transform:scale(0.95)}
.speak-btn.small{font-size:1.1rem;padding:2px 4px}
.auto-speak{display:flex;align-items:center;justify-content:center;gap:6px;margin:8px 0;font-size:0.8rem;color:var(--muted)}
.auto-speak input{margin:0}

/* Word list */
.word-list{max-height:400px;overflow-y:auto;text-align:left}
.word-item{display:flex;justify-content:space-between;align-items:center;padding:10px 8px;border-bottom:1px solid var(--border);font-size:0.85rem;gap:6px}
.word-item .wi-left{flex:1}
.word-item .eng{font-weight:700;font-size:0.95rem}
.word-item .def{color:var(--muted);font-size:0.8rem}
.word-item .badge{font-size:0.65rem;padding:2px 8px;border-radius:99px;font-weight:700;white-space:nowrap}
.badge-mastered{background:#dcfce7;color:#16a34a}
.badge-learning{background:#fef3c7;color:#d97706}
.badge-new{background:#e0e7ff;color:#4f46e5}
.filter-tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.filter-tab{padding:6px 14px;border-radius:99px;border:1px solid var(--border);font-size:0.8rem;cursor:pointer;background:#fff}
.filter-tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.reveal-area{margin:8px 0;min-height:32px}
.reveal-word{font-size:1.4rem;font-weight:800;color:var(--danger)}
.reset-section{margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}

@media(max-width:760px){
  .layout{flex-direction:column}
  .side-col{width:100%}
  .wrong-list{max-height:200px}
  .options{grid-template-columns:1fr}
  .input-row input{width:220px;font-size:1.1rem}
  .clue-chinese{font-size:1.3rem}
  .quiz-word{font-size:1.8rem}
  .nav button{padding:6px 12px;font-size:0.75rem}
}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ“š NAPLAN Vocabulary å•è¯å­¦ä¹ </h1>
  <p>Spell Â· Match Â· Quiz Â· Learn until you know it! å­¦åˆ°ä¼šä¸ºæ­¢ï¼</p>
</div>

<div class="stats-bar">
  <div class="stat"><div class="stat-num green" id="s-mastered">0</div><div class="stat-label">Mastered âœ…</div></div>
  <div class="stat"><div class="stat-num orange" id="s-learning">0</div><div class="stat-label">Learning ğŸ“</div></div>
  <div class="stat"><div class="stat-num" id="s-new">0</div><div class="stat-label">New ğŸ†•</div></div>
  <div class="stat"><div class="stat-num red" id="s-wrong">0</div><div class="stat-label">Wrong âŒ</div></div>
  <div class="stat"><div class="stat-num" id="s-total">0</div><div class="stat-label">Total</div></div>
</div>

<div class="nav">
  <button class="active" onclick="switchMode('spell')">âœï¸ Spell æ‹¼å†™</button>
  <button onclick="switchMode('match')">ğŸ”¤ Match é…å¯¹</button>
  <button onclick="switchMode('quiz')">ğŸ¯ Quiz è¯ä¹‰</button>
  <button onclick="switchMode('list')">ğŸ“‹ List è¯è¡¨</button>
  <button onclick="switchMode('wrong')">âŒ Wrong é”™é¢˜æœ¬</button>
</div>

<div class="layout">
<div class="main-col">

  <!-- SPELL MODE -->
  <div id="mode-spell">
    <div class="card">
      <h2>âœï¸ Spell the Word æ‹¼å†™å•è¯</h2>
      <div class="subtitle">Read the meaning, then type the word Â· çœ‹é‡Šä¹‰ï¼Œæ‹¼å‡ºå•è¯</div>
      <div class="auto-speak"><label><input type="checkbox" id="auto-speak" checked> ğŸ”Š Auto-play sound è‡ªåŠ¨è¯»éŸ³</label></div>
      <div class="clue-box">
        <div class="clue-english" id="spell-en"></div>
        <div class="clue-chinese" id="spell-cn"></div>
      </div>
      <div class="letter-hint" id="spell-hint"></div>
      <div class="input-row">
        <input type="text" id="spell-input" placeholder="Type the word here..." autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
      </div>
      <div class="feedback" id="spell-feedback"></div>
      <div class="reveal-area" id="spell-reveal"></div>
      <div class="btn-row">
        <button class="btn btn-warning" onclick="goBack()">â† Back è¿”å›</button>
        <button class="btn btn-primary" onclick="checkSpelling()">Check âœ“</button>
        <button class="btn btn-outline" onclick="showHint()">Hint ğŸ’¡</button>
        <button class="btn btn-outline" onclick="speakWord()">ğŸ”Š Listen</button>
        <button class="btn btn-outline" onclick="revealAnswer()">Show ğŸ‘€</button>
        <button class="btn btn-success" onclick="nextSpell()">Next â†’</button>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
    </div>
  </div>

  <!-- MATCH MODE -->
  <div id="mode-match" style="display:none">
    <div class="card">
      <h2>ğŸ”¤ Pick the Word é€‰å•è¯</h2>
      <div class="subtitle">Read the meaning, pick the correct word Â· çœ‹é‡Šä¹‰ï¼Œé€‰æ­£ç¡®å•è¯</div>
      <div class="clue-box">
        <div class="clue-english" id="match-en"></div>
        <div class="clue-chinese" id="match-cn"></div>
      </div>
      <div class="options options-words" id="match-options"></div>
      <div class="feedback" id="match-feedback"></div>
      <div class="btn-row">
        <button class="btn btn-warning" onclick="goBack()">â† Back è¿”å›</button>
        <button class="btn btn-outline" onclick="speakWord()">ğŸ”Š Listen</button>
        <button class="btn btn-success" id="match-next" onclick="nextMatch()" style="display:none">Next â†’</button>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progress-bar2"></div></div>
    </div>
  </div>

  <!-- QUIZ MODE -->
  <div id="mode-quiz" style="display:none">
    <div class="card">
      <h2>ğŸ¯ What Does It Mean? ä»€ä¹ˆæ„æ€ï¼Ÿ</h2>
      <div class="subtitle">See the word, pick the correct meaning Â· çœ‹å•è¯ï¼Œé€‰æ­£ç¡®é‡Šä¹‰</div>
      <div class="quiz-word" id="quiz-word"></div>
      <button class="speak-btn" onclick="speakWord()" title="Listen">ğŸ”Š</button>
      <div class="options" id="quiz-options"></div>
      <div class="feedback" id="quiz-feedback"></div>
      <div class="btn-row">
        <button class="btn btn-warning" onclick="goBack()">â† Back è¿”å›</button>
        <button class="btn btn-success" id="quiz-next" onclick="nextQuiz()" style="display:none">Next â†’</button>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progress-bar3"></div></div>
    </div>
  </div>

  <!-- WORD LIST -->
  <div id="mode-list" style="display:none">
    <div class="card">
      <h2>ğŸ“‹ Word List è¯æ±‡è¡¨</h2>
      <div class="filter-tabs">
        <div class="filter-tab active" onclick="filterList('all',this)">All å…¨éƒ¨</div>
        <div class="filter-tab" onclick="filterList('new',this)">ğŸ†• New</div>
        <div class="filter-tab" onclick="filterList('learning',this)">ğŸ“ Learning</div>
        <div class="filter-tab" onclick="filterList('mastered',this)">âœ… Mastered</div>
      </div>
      <div class="word-list" id="word-list"></div>
      <div class="reset-section">
        <button class="btn btn-danger btn-small" onclick="resetProgress()">ğŸ”„ Reset All Progress é‡ç½®è¿›åº¦</button>
      </div>
    </div>
  </div>

  <!-- WRONG BOOK (full page) -->
  <div id="mode-wrong" style="display:none">
    <div class="card">
      <h2>âŒ Wrong Book é”™é¢˜æœ¬</h2>
      <div class="subtitle">Words you got wrong Â· ç­”é”™çš„å•è¯</div>
      <div id="wrong-full-list"></div>
      <div class="btn-row" style="margin-top:16px">
        <button class="btn btn-danger btn-small" onclick="clearWrongBook()">ğŸ—‘ï¸ Clear All æ¸…ç©ºé”™é¢˜æœ¬</button>
        <button class="btn btn-primary btn-small" onclick="practiceWrong()">ğŸ“ Practice Wrong Words ç»ƒé”™é¢˜</button>
      </div>
    </div>
  </div>

</div>

<!-- SIDEBAR: Wrong book (live) -->
<div class="side-col">
  <div class="wrong-book" id="wrong-sidebar">
    <h3>âŒ Wrong Book é”™é¢˜æœ¬ <span class="count" id="wrong-count">0</span></h3>
    <div class="wrong-list" id="wrong-list"></div>
    <div class="clear-btn">
      <button class="btn btn-outline btn-small" onclick="clearWrongBook()">ğŸ—‘ï¸ Clear æ¸…ç©º</button>
    </div>
  </div>
</div>

</div>

<script src="vocab.js"></script>
<script>
// === State ===
const STORAGE_KEY = 'naplan-vocab-v2';
const WRONG_KEY = 'naplan-wrong-v1';
let state = loadState();
let wrongBook = loadWrongBook(); // { word: { count: N, m: "...", e: "..." } }
let currentWord = null;
let previousWord = null; // for Go Back
let previousState = null; // snapshot for Go Back
let currentMode = 'spell';
let hintLevel = 0;
let answered = false;
let spellChecked = false; // track if user checked before next
let listFilter = 'all';
let history = []; // word history stack

function loadState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } }
function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadWrongBook() { try { return JSON.parse(localStorage.getItem(WRONG_KEY)) || {}; } catch { return {}; } }
function saveWrongBook() { localStorage.setItem(WRONG_KEY, JSON.stringify(wrongBook)); renderWrongSidebar(); }

function ws(w) {
  if (!state[w]) state[w] = { sp:0, ma:0, qu:0, att:0, t:0 };
  return state[w];
}

function getStatus(w) {
  const s = ws(w);
  if (s.sp >= 2 && (s.ma >= 2 || s.qu >= 2)) return 'mastered';
  if (s.att > 0) return 'learning';
  return 'new';
}

function getCounts() {
  let m=0,l=0,n=0;
  for (const v of VOCAB) { const st=getStatus(v.w); if(st==='mastered')m++; else if(st==='learning')l++; else n++; }
  return {mastered:m, learning:l, new:n, total:VOCAB.length, wrong:Object.keys(wrongBook).length};
}

function updateStats() {
  const c = getCounts();
  document.getElementById('s-mastered').textContent = c.mastered;
  document.getElementById('s-learning').textContent = c.learning;
  document.getElementById('s-new').textContent = c.new;
  document.getElementById('s-wrong').textContent = c.wrong;
  document.getElementById('s-total').textContent = c.total;
  const pct = c.total > 0 ? (c.mastered / c.total * 100) : 0;
  document.querySelectorAll('[id^="progress-bar"]').forEach(el => el.style.width = pct + '%');
  document.getElementById('wrong-count').textContent = c.wrong;
}

// === Wrong Book ===
function addToWrongBook(v) {
  const key = v.w;
  if (!wrongBook[key]) {
    wrongBook[key] = { count: 1, m: v.m, e: enDef(v) };
  } else {
    wrongBook[key].count++;
  }
  saveWrongBook();
  updateStats();
}

function renderWrongSidebar() {
  const entries = Object.entries(wrongBook).sort((a,b) => b[1].count - a[1].count);
  const container = document.getElementById('wrong-list');
  if (!entries.length) {
    container.innerHTML = '<div class="wrong-empty">ğŸ‰ No wrong words!<br>æ²¡æœ‰é”™é¢˜ï¼</div>';
    return;
  }
  let html = '';
  for (const [w, info] of entries) {
    html += `<div class="wrong-item">
      <button class="speak-btn small" onclick="speak('${w}','en-US')">ğŸ”Š</button>
      <span class="wi-word">${w}</span>
      <span class="wi-def">${info.e} Â· ${info.m}</span>
      <span class="wi-count">Ã—${info.count}</span>
    </div>`;
  }
  container.innerHTML = html;
}

function renderWrongFullList() {
  const entries = Object.entries(wrongBook).sort((a,b) => b[1].count - a[1].count);
  const container = document.getElementById('wrong-full-list');
  if (!entries.length) {
    container.innerHTML = '<div class="wrong-empty" style="padding:40px">ğŸ‰ Great job! No wrong words!<br>å¤ªæ£’äº†ï¼æ²¡æœ‰é”™é¢˜ï¼</div>';
    return;
  }
  let html = '<div class="word-list" style="max-height:500px">';
  for (const [w, info] of entries) {
    html += `<div class="word-item">
      <button class="speak-btn small" onclick="speak('${w}','en-US')">ğŸ”Š</button>
      <div class="wi-left"><span class="eng" style="color:var(--danger)">${w}</span><br>
      <span class="def">${info.e} Â· ${info.m}</span></div>
      <span style="color:var(--danger);font-weight:700;font-size:0.85rem">Ã—${info.count}</span>
    </div>`;
  }
  html += '</div>';
  container.innerHTML = html;
}

function clearWrongBook() {
  if (confirm('Clear all wrong words? ç¡®å®šæ¸…ç©ºé”™é¢˜æœ¬ï¼Ÿ')) {
    wrongBook = {};
    saveWrongBook();
    updateStats();
    renderWrongFullList();
  }
}

function practiceWrong() {
  // Switch to spell mode but only with wrong words
  alert('Tip: Wrong words are already prioritized in your practice!\næç¤ºï¼šé”™é¢˜å•è¯å·²ç»åœ¨ç»ƒä¹ ä¸­ä¼˜å…ˆå‡ºç°äº†ï¼');
  switchModeByName('spell');
}

// === Word picker ===
function pickWord() {
  const now = Date.now();
  const cands = [];
  for (const v of VOCAB) {
    const s = ws(v.w);
    const st = getStatus(v.w);
    if (st === 'mastered') continue;
    let pri;
    if (wrongBook[v.w]) pri = -1;
    else if (st === 'learning') pri = 0;
    else pri = 1;
    cands.push({ v, pri, age: now - (s.t||0) });
  }
  if (!cands.length) return VOCAB[Math.floor(Math.random()*VOCAB.length)];
  // Group by priority, then pick randomly within each group
  const minPri = Math.min(...cands.map(c => c.pri));
  const topGroup = cands.filter(c => c.pri === minPri);
  // Pick randomly from top priority group (truly random, no alphabetical bias)
  return topGroup[Math.floor(Math.random() * topGroup.length)].v;
}

function enDef(v) { return v.e || v.m; }

// === GO BACK ===
function saveSnapshot() {
  return JSON.parse(JSON.stringify(state));
}

function goBack() {
  if (!previousWord) return;
  // Restore state
  if (previousState) {
    state = previousState;
    saveState();
  }
  // Remove from wrong book if it was added this round
  // (we'll just reload the previous word)
  currentWord = previousWord;
  previousWord = null;
  previousState = null;
  
  if (currentMode === 'spell') restoreSpell();
  else if (currentMode === 'match') restoreMatch();
  else if (currentMode === 'quiz') restoreQuiz();
  
  updateStats();
  renderWrongSidebar();
}

function restoreSpell() {
  hintLevel = 0; spellChecked = false;
  document.getElementById('spell-en').textContent = enDef(currentWord);
  document.getElementById('spell-cn').textContent = currentWord.m;
  document.getElementById('spell-hint').textContent = `( ${currentWord.w.length} letters )`;
  document.getElementById('spell-input').value = '';
  document.getElementById('spell-input').className = '';
  document.getElementById('spell-feedback').innerHTML = '<span style="color:var(--warning)">â¬…ï¸ Went back Â· å·²è¿”å›ä¸Šä¸€é¢˜</span>';
  document.getElementById('spell-reveal').innerHTML = '';
  document.getElementById('spell-input').focus();
}

// === SPELL MODE ===
function loadSpell() {
  previousWord = currentWord;
  previousState = saveSnapshot();
  currentWord = pickWord();
  hintLevel = 0; spellChecked = false;
  document.getElementById('spell-en').textContent = enDef(currentWord);
  document.getElementById('spell-cn').textContent = currentWord.m;
  document.getElementById('spell-hint').textContent = `( ${currentWord.w.length} letters )`;
  document.getElementById('spell-input').value = '';
  document.getElementById('spell-input').className = '';
  document.getElementById('spell-feedback').innerHTML = '';
  document.getElementById('spell-reveal').innerHTML = '';
  document.getElementById('spell-input').focus();
}

function checkSpelling() {
  const inp = document.getElementById('spell-input').value.trim().toLowerCase();
  if (!inp) return;
  const correct = currentWord.w.toLowerCase();
  const s = ws(currentWord.w); s.att++; s.t = Date.now();
  spellChecked = true;

  if (inp === correct) {
    s.sp++;
    document.getElementById('spell-input').className = 'correct';
    document.getElementById('spell-feedback').innerHTML = '<span class="correct">âœ… Correct! æ­£ç¡®ï¼</span>';
    speak(currentWord.w, 'en-US');
    saveState(); updateStats();
    setTimeout(loadSpell, 1500);
  } else {
    s.sp = Math.max(0, s.sp - 1);
    document.getElementById('spell-input').className = 'wrong';
    document.getElementById('spell-feedback').innerHTML = `<span class="wrong">âŒ Try again! å†è¯•ä¸€æ¬¡ï¼ (Answer: ${currentWord.w})</span>`;
    addToWrongBook(currentWord); // add to wrong book on first wrong attempt
    saveState(); updateStats();
  }
}

function showHint() {
  if (!currentWord) return;
  hintLevel++;
  const w = currentWord.w;
  let hint;
  if (hintLevel === 1) hint = w[0] + ' _ '.repeat(w.length-2).trim() + ' ' + w[w.length-1];
  else if (hintLevel === 2) hint = w.split('').map((c,i) => i%2===0?c:'_').join(' ');
  else { const h=Math.floor(Math.random()*(w.length-2))+1; hint=w.split('').map((c,i) => i===h?'_':c).join(' '); }
  document.getElementById('spell-hint').textContent = hint;
}

function revealAnswer() {
  if (!currentWord) return;
  document.getElementById('spell-reveal').innerHTML = `<span class="reveal-word">${currentWord.w}</span>`;
  speak(currentWord.w, 'en-US');
  if (!spellChecked) {
    // User revealed without trying â€” counts as wrong
    addToWrongBook(currentWord);
  }
  const s = ws(currentWord.w); s.sp = Math.max(0, s.sp-1); s.att++; s.t = Date.now();
  saveState(); updateStats();
}

function nextSpell() { loadSpell(); }

// === MATCH MODE ===
function loadMatch() {
  previousWord = currentWord;
  previousState = saveSnapshot();
  currentWord = pickWord(); answered = false;
  document.getElementById('match-en').textContent = enDef(currentWord);
  document.getElementById('match-cn').textContent = currentWord.m;
  document.getElementById('match-feedback').innerHTML = '';
  document.getElementById('match-next').style.display = 'none';
  autoSpeak();

  const correctW = currentWord.w;
  const wrongs = [];
  const pool = VOCAB.filter(v => v.w !== correctW);
  const len = correctW.length;
  pool.sort((a,b) => Math.abs(a.w.length-len) - Math.abs(b.w.length-len));
  const similar = pool.slice(0, Math.min(30, pool.length));
  while (wrongs.length < 3 && similar.length > 0) {
    const idx = Math.floor(Math.random()*similar.length);
    wrongs.push(similar[idx].w);
    similar.splice(idx,1);
  }
  const opts = [correctW, ...wrongs]; shuffle(opts);
  const container = document.getElementById('match-options');
  container.innerHTML = '';
  opts.forEach(w => {
    const btn = document.createElement('div');
    btn.className = 'option'; btn.textContent = w;
    btn.onclick = () => selectMatch(btn, w, correctW);
    container.appendChild(btn);
  });
}

function restoreMatch() {
  answered = false;
  document.getElementById('match-en').textContent = enDef(currentWord);
  document.getElementById('match-cn').textContent = currentWord.m;
  document.getElementById('match-feedback').innerHTML = '<span style="color:var(--warning)">â¬…ï¸ Went back Â· å·²è¿”å›ä¸Šä¸€é¢˜</span>';
  document.getElementById('match-next').style.display = 'none';
  const correctW = currentWord.w;
  const wrongs = [];
  const pool = VOCAB.filter(v => v.w !== correctW);
  const len = correctW.length;
  pool.sort((a,b) => Math.abs(a.w.length-len) - Math.abs(b.w.length-len));
  const similar = pool.slice(0, Math.min(30, pool.length));
  while (wrongs.length < 3 && similar.length > 0) {
    const idx = Math.floor(Math.random()*similar.length); wrongs.push(similar[idx].w); similar.splice(idx,1);
  }
  const opts = [correctW, ...wrongs]; shuffle(opts);
  const container = document.getElementById('match-options');
  container.innerHTML = '';
  opts.forEach(w => {
    const btn = document.createElement('div'); btn.className = 'option'; btn.textContent = w;
    btn.onclick = () => selectMatch(btn, w, correctW);
    container.appendChild(btn);
  });
}

function selectMatch(btn, selected, correct) {
  if (answered) return;
  answered = true;
  document.querySelectorAll('#match-options .option').forEach(o => o.classList.add('disabled'));
  const s = ws(currentWord.w); s.att++; s.t = Date.now();
  if (selected === correct) {
    s.ma++; btn.classList.add('correct');
    document.getElementById('match-feedback').innerHTML = '<span class="correct">âœ… Correct! æ­£ç¡®ï¼</span>';
  } else {
    s.ma = Math.max(0, s.ma-1); btn.classList.add('wrong');
    document.querySelectorAll('#match-options .option').forEach(o => { if(o.textContent===correct) o.classList.add('correct'); });
    document.getElementById('match-feedback').innerHTML = `<span class="wrong">âŒ Answer: <strong>${correct}</strong></span>`;
    addToWrongBook(currentWord);
  }
  saveState(); updateStats();
  document.getElementById('match-next').style.display = 'inline-block';
}

function nextMatch() { loadMatch(); }

// === QUIZ MODE ===
function loadQuiz() {
  previousWord = currentWord;
  previousState = saveSnapshot();
  currentWord = pickWord(); answered = false;
  document.getElementById('quiz-word').textContent = currentWord.w;
  document.getElementById('quiz-feedback').innerHTML = '';
  document.getElementById('quiz-next').style.display = 'none';
  autoSpeak();

  const correctM = currentWord.m, correctE = enDef(currentWord);
  const wrongs = [];
  const pool = VOCAB.filter(v => v.w !== currentWord.w);
  while (wrongs.length < 3 && pool.length > 0) {
    const idx = Math.floor(Math.random()*pool.length);
    const v = pool[idx];
    if (!wrongs.find(x => x.m === v.m)) wrongs.push({ m: v.m, e: enDef(v) });
    pool.splice(idx,1);
  }
  const opts = [{ m:correctM, e:correctE, correct:true }, ...wrongs.map(x=>({...x,correct:false}))];
  shuffle(opts);
  const container = document.getElementById('quiz-options');
  container.innerHTML = '';
  opts.forEach(opt => {
    const btn = document.createElement('div'); btn.className = 'option';
    btn.innerHTML = `<div class="opt-en">${opt.e}</div><div class="opt-cn">${opt.m}</div>`;
    btn.onclick = () => selectQuiz(btn, opt.correct, correctE, correctM);
    container.appendChild(btn);
  });
}

function restoreQuiz() {
  answered = false;
  document.getElementById('quiz-word').textContent = currentWord.w;
  document.getElementById('quiz-feedback').innerHTML = '<span style="color:var(--warning)">â¬…ï¸ Went back Â· å·²è¿”å›ä¸Šä¸€é¢˜</span>';
  document.getElementById('quiz-next').style.display = 'none';
  const correctM = currentWord.m, correctE = enDef(currentWord);
  const wrongs = [];
  const pool = VOCAB.filter(v => v.w !== currentWord.w);
  while (wrongs.length < 3 && pool.length > 0) {
    const idx = Math.floor(Math.random()*pool.length); const v = pool[idx];
    if (!wrongs.find(x => x.m === v.m)) wrongs.push({ m: v.m, e: enDef(v) });
    pool.splice(idx,1);
  }
  const opts = [{ m:correctM, e:correctE, correct:true }, ...wrongs.map(x=>({...x,correct:false}))];
  shuffle(opts);
  const container = document.getElementById('quiz-options');
  container.innerHTML = '';
  opts.forEach(opt => {
    const btn = document.createElement('div'); btn.className = 'option';
    btn.innerHTML = `<div class="opt-en">${opt.e}</div><div class="opt-cn">${opt.m}</div>`;
    btn.onclick = () => selectQuiz(btn, opt.correct, correctE, correctM);
    container.appendChild(btn);
  });
}

function selectQuiz(btn, isCorrect, correctE, correctM) {
  if (answered) return;
  answered = true;
  document.querySelectorAll('#quiz-options .option').forEach(o => o.classList.add('disabled'));
  const s = ws(currentWord.w); s.att++; s.t = Date.now();
  if (isCorrect) {
    s.qu++; btn.classList.add('correct');
    document.getElementById('quiz-feedback').innerHTML = '<span class="correct">âœ… Correct! æ­£ç¡®ï¼</span>';
  } else {
    s.qu = Math.max(0, s.qu-1); btn.classList.add('wrong');
    document.querySelectorAll('#quiz-options .option').forEach(o => {
      if (o.querySelector('.opt-en').textContent === correctE) o.classList.add('correct');
    });
    document.getElementById('quiz-feedback').innerHTML = `<span class="wrong">âŒ Answer: ${correctE} / ${correctM}</span>`;
    addToWrongBook(currentWord);
  }
  saveState(); updateStats();
  document.getElementById('quiz-next').style.display = 'inline-block';
}

function nextQuiz() { loadQuiz(); }

// === WORD LIST ===
function renderList() {
  const sorted = [...VOCAB].sort((a,b) => a.w.localeCompare(b.w));
  let html = '';
  for (const v of sorted) {
    const st = getStatus(v.w);
    if (listFilter !== 'all' && st !== listFilter) continue;
    let bc, bt;
    if (st==='mastered'){bc='badge-mastered';bt='âœ… Mastered';}
    else if(st==='learning'){bc='badge-learning';bt='ğŸ“ Learning';}
    else{bc='badge-new';bt='ğŸ†• New';}
    const inWrong = wrongBook[v.w] ? `<span style="color:var(--danger);font-size:0.7rem"> Ã—${wrongBook[v.w].count}</span>` : '';
    html += `<div class="word-item">
      <button class="speak-btn small" onclick="speak('${v.w}','en-US')">ğŸ”Š</button>
      <div class="wi-left"><span class="eng">${v.w}</span>${inWrong}<br>
      <span class="def">${enDef(v)} Â· ${v.m}</span></div>
      <span class="badge ${bc}">${bt}</span></div>`;
  }
  if(!html) html = '<div style="padding:20px;text-align:center;color:var(--muted)">No words found</div>';
  document.getElementById('word-list').innerHTML = html;
}

function filterList(f, el) {
  listFilter = f;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderList();
}

function resetProgress() {
  if (confirm('Reset ALL progress? ç¡®å®šé‡ç½®æ‰€æœ‰è¿›åº¦ï¼Ÿ')) {
    state = {}; wrongBook = {};
    saveState(); saveWrongBook(); updateStats(); init();
  }
}

// === TTS ===
let voices = [];
function loadVoices() { voices = speechSynthesis.getVoices(); }
speechSynthesis.onvoiceschanged = loadVoices; loadVoices();

function getEnVoice() {
  return voices.find(v => v.lang.startsWith('en') && v.name.includes('Google')) ||
    voices.find(v => v.lang.startsWith('en-US')) ||
    voices.find(v => v.lang.startsWith('en-AU')) ||
    voices.find(v => v.lang.startsWith('en')) || null;
}

function speak(text, lang) {
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang || 'en-US'; u.rate = 0.85;
  const v = getEnVoice();
  if (v && (lang||'en').startsWith('en')) u.voice = v;
  speechSynthesis.speak(u);
}

function speakWord() { if (currentWord) speak(currentWord.w, 'en-US'); }

function autoSpeak() {
  const cb = document.getElementById('auto-speak');
  if (cb && cb.checked && currentWord) setTimeout(() => speak(currentWord.w, 'en-US'), 300);
}

// === Helpers ===
function shuffle(arr) {
  for (let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}
}

function switchModeByName(mode) {
  currentMode = mode;
  document.querySelectorAll('.nav button').forEach(b => {
    b.classList.toggle('active', b.textContent.toLowerCase().includes(mode));
  });
  ['spell','match','quiz','list','wrong'].forEach(m => {
    const el = document.getElementById('mode-'+m);
    if (el) el.style.display = m===mode?'block':'none';
  });
  if (mode==='spell') loadSpell();
  else if (mode==='match') loadMatch();
  else if (mode==='quiz') loadQuiz();
  else if (mode==='list') renderList();
  else if (mode==='wrong') renderWrongFullList();
}

function switchMode(mode) {
  currentMode = mode;
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  ['spell','match','quiz','list','wrong'].forEach(m => {
    const el = document.getElementById('mode-'+m);
    if (el) el.style.display = m===mode?'block':'none';
  });
  if (mode==='spell') loadSpell();
  else if (mode==='match') loadMatch();
  else if (mode==='quiz') loadQuiz();
  else if (mode==='list') renderList();
  else if (mode==='wrong') renderWrongFullList();
}

function init() {
  updateStats();
  renderWrongSidebar();
  loadSpell();
}

document.addEventListener('keydown', e => {
  if (currentMode==='spell' && e.key==='Enter') checkSpelling();
});

init();
</script>
</body>
</html>
